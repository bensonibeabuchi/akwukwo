trigger:
- main

variables:
- group: akwukwo-secrets

- name: appServiceName
  value: akwukwo

pool:
  vmImage: ubuntu-latest

stages:
- stage: Build
  displayName: 'Build Stage'
  jobs:
    - job: Build
      displayName: 'Build'
      pool:
        vmImage: 'ubuntu-latest'
      steps:
        - checkout: self

        - task: NodeTool@0
          inputs:
            versionSpec: '18.x'
          displayName: 'Use Node.js 18'

        - script: |
            echo "üì¶ Installing dependencies..."
            npm ci
          displayName: 'Install dependencies'

        - task: PublishTestResults@2
          inputs:
            testResultsFormat: 'JUnit'
            testResultsFiles: '**/results.xml'
            failTaskOnFailedTests: true
          condition: succeededOrFailed()
          displayName: 'Publish test results (optional)'

- stage: Terraform
  displayName: 'Terraform Infrastructure Deployment'
  dependsOn: Build
  condition: succeeded()   
  jobs:
  - job: terraform
    displayName: 'Provision Infrastructure with Terraform'
    steps:
    # 1Ô∏è‚É£ Install Terraform
    - task: TerraformInstaller@1
      displayName: 'Install Terraform'
      inputs:
        terraformVersion: 'latest'

    # 2Ô∏è‚É£ Azure login & Terraform steps
    - task: AzureCLI@2
      displayName: 'Terraform: Init, Import, Plan, Apply'
      inputs:
        azureSubscription: 'azure-akwukwo-connection'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "üì¶ Switching to infra directory"
          cd infra

          echo "üöÄ Initializing Terraform backend..."
          terraform init -reconfigure \
            -backend-config="resource_group_name=akwukwo-rg" \
            -backend-config="storage_account_name=akwukwoterraformsa" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=terraform.tfstate"

          echo "ü™Ñ Checking and importing existing resources..."

          # -----------------------------
          # Resource Group
          # -----------------------------
          if ! terraform state list | grep -q azurerm_resource_group.rg; then
            echo "üì¶ Importing existing resource group..."
            terraform import azurerm_resource_group.rg /subscriptions/$subscription_id/resourceGroups/$resource_group_name
          else
            echo "‚úÖ Resource group already in state"
          fi

          # -----------------------------
          # App Service
          # -----------------------------
          if ! terraform state list | grep -q azurerm_linux_web_app.app_with_secrets; then
            echo "üì¶ Importing existing App Service..."
            terraform import azurerm_linux_web_app.app_with_secrets \
              /subscriptions/$subscription_id/resourceGroups/$resource_group_name/providers/Microsoft.Web/sites/$appServiceName
          else
            echo "‚úÖ App Service already in state"
          fi

          # -----------------------------
          # Key Vault
          # -----------------------------
          if ! terraform state list | grep -q azurerm_key_vault.kv; then
            echo "üì¶ Importing existing Key Vault..."
            terraform import azurerm_key_vault.kv \
              /subscriptions/$subscription_id/resourceGroups/$resource_group_name/providers/Microsoft.KeyVault/vaults/$kvName
          else
            echo "‚úÖ Key Vault already in state"
          fi

          # -----------------------------
          # Key Vault Access Policy
          # -----------------------------
          # if ! terraform state list | grep -q azurerm_key_vault_access_policy.app_policy; then
          #  echo "üì¶ Importing Key Vault access policy..."
          #  terraform import azurerm_key_vault_access_policy.app_policy \
          #    "/subscriptions/$subscription_id/resourceGroups/$resource_group_name/providers/Microsoft.KeyVault/vaults/$kvName/objectId/$appPrincipalId"
          # else
          #  echo "‚úÖ Key Vault access policy already in state"
          #fi

          echo "üß© Validating Terraform configuration..."
          terraform validate

          echo "ü™Ñ Planning Terraform changes..."
          terraform plan -out=tfplan -var-file=terraform.tfvars

          echo "‚öôÔ∏è Applying Terraform..."
          terraform apply -auto-approve tfplan

      env:
        TF_VAR_dockerhub_username: $(dockerhub_username)
        TF_VAR_dockerhub_password: $(dockerhub_password)
        TF_VAR_database_url: $(database_url)
        TF_VAR_supabase_anon_key: $(supabase_anon_key)
        TF_VAR_supabase_url: $(supabase_url)
        TF_VAR_supabase_host: $(supabase_host)
        subscription_id: $(subscription_id)
        resource_group_name: $(resource_group_name)
        kvName: $(kvName)
        appPrincipalId: $(appPrincipalId)
        appServiceName: $(appServiceName)